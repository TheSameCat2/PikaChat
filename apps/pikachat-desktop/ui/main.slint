import { AboutSlint, Button, ListView, TextEdit } from "std-widgets.slint";

export struct RoomRow {
    room_id: string,
    display_name: string,
    unread_badge: string,
    highlight_badge: string,
    has_unread: bool,
    has_highlight: bool,
    is_selected: bool,
}

export struct MessageRow {
    event_id: string,
    sender: string,
    body: string,
    is_own: bool,
}

export component MainWindow inherits Window {
    title: "PikaChat";
    width: 1200px;
    height: 780px;

    callback quit-requested();
    callback about-slint-requested();
    callback room-selected(index: int);
    callback send-message-requested(text: string) -> bool;
    callback timeline-scrolled(viewport_y: float);
    callback sidebar-width-requested(width_px: float, window_width_px: float);

    in-out property <bool> show-about-screen: false;
    in-out property <float> sidebar-width-px: 280.0;
    in-out property <string> composer-text: "";

    in property <[RoomRow]> rooms;
    in property <[MessageRow]> messages;
    in property <string> selected-room-id: "";
    in property <string> status-text: "Idle";
    in property <string> error-text: "";
    in property <bool> has-error: false;
    in property <bool> can-send: false;

    menu_bar := MenuBar {
        Menu {
            title: "File";
            MenuItem {
                title: "Quit";
                activated => {
                    root.quit-requested();
                }
            }
        }

        Menu {
            title: "Help";
            MenuItem {
                title: "About Slint...";
                activated => {
                    root.about-slint-requested();
                }
            }
        }
    }

    app-bg := Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #10151f;

        sidebar := Rectangle {
            x: 0;
            y: 0;
            width: min(max(root.sidebar-width-px * 1px, 220px), parent.width * 0.45);
            height: parent.height;
            background: #171d29;
            border-width: 0px;

            Text {
                x: 14px;
                y: 14px;
                text: "Rooms";
                color: #e6ecff;
                font-size: 22px;
                font-weight: 600;
            }

            room-list := ListView {
                x: 8px;
                y: 52px;
                width: parent.width - 16px;
                height: parent.height - self.y - 8px;
                vertical-scrollbar-policy: ScrollBarPolicy.as-needed;
                horizontal-scrollbar-policy: ScrollBarPolicy.as-needed;

                for room[index] in root.rooms: Rectangle {
                    height: 62px;
                    border-radius: 10px;
                    background: room.is_selected ? #2f3e66 : #202938;

                    Text {
                        x: 12px;
                        y: 10px;
                        width: parent.width - 24px;
                        text: room.display_name;
                        color: room.is_selected ? #ffffff : #d4dcf5;
                        font-size: 14px;
                        overflow: elide;
                    }

                    if room.has_unread: Rectangle {
                        width: 30px;
                        height: 20px;
                        x: parent.width - self.width - 44px;
                        y: 34px;
                        border-radius: 10px;
                        background: #3f7ce8;

                        Text {
                            text: room.unread_badge;
                            color: #ffffff;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            font-size: 12px;
                        }
                    }

                    if room.has_highlight: Rectangle {
                        width: 30px;
                        height: 20px;
                        x: parent.width - self.width - 8px;
                        y: 34px;
                        border-radius: 10px;
                        background: #e14668;

                        Text {
                            text: room.highlight_badge;
                            color: #ffffff;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            font-size: 12px;
                        }
                    }

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            root.room-selected(index);
                        }
                    }
                }
            }
        }

        divider := Rectangle {
            x: sidebar.width;
            y: 0;
            width: 8px;
            height: parent.height;
            background: #293347;

            drag := TouchArea {
                width: parent.width;
                height: parent.height;
                mouse-cursor: MouseCursor.col-resize;
                property <float> drag-start-width: 0;

                pointer-event(event) => {
                    if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                        self.drag-start-width = root.sidebar-width-px;
                    }
                }

                moved => {
                    if (self.pressed) {
                        root.sidebar-width-requested(
                            self.drag-start-width + ((self.mouse-x - self.pressed-x) / 1px),
                            app-bg.width / 1px
                        );
                    }
                }
            }
        }

        chat-pane := Rectangle {
            x: divider.x + divider.width;
            y: 0;
            width: parent.width - self.x;
            height: parent.height;
            background: #0f1420;

            status-bar := Rectangle {
                x: 0;
                y: 0;
                width: parent.width;
                height: 38px;
                background: #141b2a;

                Text {
                    x: 14px;
                    y: (parent.height - self.height) / 2;
                    text: root.status-text;
                    color: #b9c3dd;
                    font-size: 13px;
                }
            }

            if root.has-error : Rectangle {
                x: 10px;
                y: status-bar.height + 8px;
                width: parent.width - 20px;
                height: 34px;
                border-radius: 8px;
                background: #65253b;
                border-width: 1px;
                border-color: #b54468;

                Text {
                    x: 10px;
                    y: (parent.height - self.height) / 2;
                    width: parent.width - 20px;
                    text: root.error-text;
                    color: #ffe4ec;
                    overflow: elide;
                }
            }

            property <length> timeline-y: root.has-error ? (status-bar.height + 50px) : (status-bar.height + 8px);

            timeline-list := ListView {
                x: 8px;
                y: chat-pane.timeline-y;
                width: parent.width - 16px;
                height: parent.height - self.y - composer.height - 12px;
                vertical-scrollbar-policy: ScrollBarPolicy.as-needed;
                horizontal-scrollbar-policy: ScrollBarPolicy.as-needed;
                scrolled => {
                    root.timeline-scrolled(self.viewport-y / 1px);
                }

                for message in root.messages: Rectangle {
                    width: parent.width;
                    height: bubble.height + 8px;

                    bubble := Rectangle {
                        width: min(parent.width * 0.68, 520px);
                        x: message.is_own ? (parent.width - self.width - 10px) : 10px;
                        y: 0;
                        border-radius: 12px;
                        border-width: 1px;
                        border-color: message.is_own ? #4e6bb0 : #344157;
                        background: message.is_own ? #2b3d66 : #202a3a;

                        sender := Text {
                            x: 12px;
                            y: 8px;
                            width: parent.width - 24px;
                            text: message.sender;
                            color: #b7c6e6;
                            font-size: 12px;
                            overflow: elide;
                        }

                        body := Text {
                            x: 12px;
                            y: sender.y + sender.height + 6px;
                            width: parent.width - 24px;
                            text: message.body;
                            color: #f2f6ff;
                            wrap: word-wrap;
                            horizontal-alignment: left;
                        }

                        height: body.y + body.height + 10px;
                    }
                }
            }

            if root.selected-room-id == "" : Text {
                text: "Select a room from the left sidebar to load chat history.";
                color: #8f9cb8;
                font-size: 16px;
                x: (parent.width - self.width) / 2;
                y: (timeline-list.y + timeline-list.height / 2) - 20px;
            }

            composer := Rectangle {
                x: 8px;
                y: parent.height - self.height - 8px;
                width: parent.width - 16px;
                height: 94px;
                border-radius: 10px;
                background: #161f2f;
                border-width: 1px;
                border-color: #2f3c56;

                input := TextEdit {
                    x: 10px;
                    y: 10px;
                    width: parent.width - send-btn.width - 28px;
                    height: parent.height - 20px;
                    text <=> root.composer-text;
                    enabled: root.can-send;

                    key-pressed(event) => {
                        if (event.text == Key.Return) {
                            if (!event.modifiers.shift) {
                                if (root.send-message-requested(root.composer-text)) {
                                    root.composer-text = "";
                                }
                                return accept;
                            }
                        }
                        reject
                    }
                }

                send-btn := Button {
                    x: parent.width - self.width - 10px;
                    y: (parent.height - self.height) / 2;
                    width: 110px;
                    text: "Send";
                    enabled: root.can-send;
                    clicked => {
                        if (root.send-message-requested(root.composer-text)) {
                            root.composer-text = "";
                        }
                    }
                }
            }
        }
    }

    if root.show-about-screen : Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        TouchArea {
            width: parent.width;
            height: parent.height;
        }

        Rectangle {
            width: 520px;
            height: 280px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #2e3440;
            border-width: 1px;
            border-color: #4c566a;
            border-radius: 10px;

            AboutSlint {
                x: (parent.width - self.width) / 2;
                y: 24px;
            }

            Button {
                text: "Close";
                width: 100px;
                x: (parent.width - self.width) / 2;
                y: parent.height - self.height - 18px;
                clicked => {
                    root.show-about-screen = false;
                }
            }
        }
    }
}
