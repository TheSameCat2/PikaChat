import { AboutSlint, Button, CheckBox, LineEdit, ListView, TextEdit } from "std-widgets.slint";

export struct RoomRow {
    room_id: string,
    display_name: string,
    unread_badge: string,
    highlight_badge: string,
    has_unread: bool,
    has_highlight: bool,
    is_selected: bool,
    is_invite: bool,
    invite_pending: bool,
    invite_pending_text: string,
}

export struct MessageRow {
    event_id: string,
    local_id: string,
    sender: string,
    body: string,
    event_kind: string,
    caption: string,
    media_status: string,
    media_source: string,
    media_cached_path: string,
    media_image: image,
    has_media_image: bool,
    can_retry: bool,
    can_remove: bool,
    is_own: bool,
}

export component MainWindow inherits Window {
    title: "PikaChat";
    width: 1200px;
    height: 780px;

    callback quit-requested();
    callback login-requested(homeserver: string, user_id: string, password: string, remember_password: bool);
    callback logout-requested();
    callback logout-confirmed();
    callback logout-cancelled();
    callback about-slint-requested();
    callback security-status-requested();
    callback backup-identity-requested();
    callback reset-identity-requested();
    callback restore-identity-requested();
    callback security-dialog-dismissed();
    callback security-copy-requested();
    callback security-restore-requested(recovery_key: string);
    callback room-selected(index: int);
    callback room-invite-accept-requested(room_id: string);
    callback room-invite-reject-requested(room_id: string);
    callback send-message-requested(text: string) -> bool;
    callback attachment-pick-requested();
    callback attachment-clear-requested();
    callback media-retry-requested(source: string);
    callback outgoing-media-retry-requested(local_id: string);
    callback outgoing-media-remove-requested(local_id: string);
    callback timeline-scrolled(viewport_y: float);
    callback sidebar-width-requested(width_px: float, window_width_px: float);

    in-out property <bool> show-about-screen: false;
    in-out property <bool> show-login-screen: false;
    in-out property <string> login-homeserver: "";
    in-out property <string> login-user-id: "";
    in-out property <string> login-password: "";
    in-out property <bool> login-remember-password: false;
    in-out property <bool> login-in-flight: false;
    in-out property <bool> show-logout-confirm: false;
    in-out property <bool> show-security-screen: false;
    in-out property <float> sidebar-width-px: 280.0;
    in-out property <string> composer-text: "";
    in-out property <string> security-title: "Identity Backup";
    in-out property <string> security-body: "";
    in-out property <bool> security-show-copy-button: false;
    in-out property <string> security-copy-button-text: "Copy Key";
    in-out property <bool> security-show-restore-input: false;
    in-out property <string> security-restore-button-text: "Restore";
    in-out property <bool> security-restore-in-flight: false;
    in-out property <bool> show-media-screen: false;
    in-out property <image> media-screen-image;

    in property <[RoomRow]> rooms;
    in property <[MessageRow]> messages;
    in property <string> selected-room-id: "";
    in property <string> status-text: "Idle";
    in property <string> error-text: "";
    in property <bool> has-error: false;
    in property <bool> can-send: false;
    in property <string> composer-attachment-name: "";
    in property <bool> has-composer-attachment: false;

    menu_bar := MenuBar {
        Menu {
            title: "File";
            MenuItem {
                title: "Logout";
                activated => {
                    root.logout-requested();
                }
            }
            MenuItem {
                title: "Quit";
                activated => {
                    root.quit-requested();
                }
            }
        }

        Menu {
            title: "Help";
            MenuItem {
                title: "About Slint...";
                activated => {
                    root.about-slint-requested();
                }
            }
        }

        Menu {
            title: "Security";
            MenuItem {
                title: "Check Backup Status";
                activated => {
                    root.security-status-requested();
                }
            }
            MenuItem {
                title: "Back Up Identity...";
                activated => {
                    root.backup-identity-requested();
                }
            }
            MenuItem {
                title: "Reset Identity Backup...";
                activated => {
                    root.reset-identity-requested();
                }
            }
            MenuItem {
                title: "Restore Identity...";
                activated => {
                    root.restore-identity-requested();
                }
            }
        }
    }

    app-bg := Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #10151f;

        sidebar := Rectangle {
            x: 0;
            y: 0;
            width: min(max(root.sidebar-width-px * 1px, 220px), parent.width * 0.45);
            height: parent.height;
            background: #171d29;
            border-width: 0px;

            Text {
                x: 14px;
                y: 14px;
                text: "Rooms";
                color: #e6ecff;
                font-size: 22px;
                font-weight: 600;
            }

            room-list := ListView {
                x: 8px;
                y: 52px;
                width: parent.width - 16px;
                height: parent.height - self.y - 8px;
                vertical-scrollbar-policy: ScrollBarPolicy.as-needed;
                horizontal-scrollbar-policy: ScrollBarPolicy.as-needed;

                for room[index] in root.rooms: Rectangle {
                    height: room.is_invite ? 98px : 62px;
                    border-radius: 10px;
                    background: room.is_selected ? #2f3e66 : #202938;

                    Text {
                        x: 12px;
                        y: 10px;
                        width: parent.width - 24px;
                        text: room.display_name;
                        color: room.is_selected ? #ffffff : #d4dcf5;
                        font-size: 14px;
                        overflow: elide;
                    }

                    if room.has_unread && !room.is_invite: Rectangle {
                        width: 30px;
                        height: 20px;
                        x: parent.width - self.width - 44px;
                        y: 34px;
                        border-radius: 10px;
                        background: #3f7ce8;

                        Text {
                            text: room.unread_badge;
                            color: #ffffff;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            font-size: 12px;
                        }
                    }

                    if room.has_highlight && !room.is_invite: Rectangle {
                        width: 30px;
                        height: 20px;
                        x: parent.width - self.width - 8px;
                        y: 34px;
                        border-radius: 10px;
                        background: #e14668;

                        Text {
                            text: room.highlight_badge;
                            color: #ffffff;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            font-size: 12px;
                        }
                    }

                    if room.is_invite: Rectangle {
                        x: 12px;
                        y: 36px;
                        width: parent.width - 24px;
                        height: parent.height - self.y - 10px;
                        background: #00000000;

                        if room.invite_pending: Text {
                            x: 0;
                            y: (parent.height - self.height) / 2;
                            width: parent.width;
                            text: room.invite_pending_text;
                            color: #9eb2dc;
                            font-size: 12px;
                            overflow: elide;
                        }

                        if !room.invite_pending: Button {
                            x: 0;
                            y: 0;
                            width: 88px;
                            text: "Accept";
                            clicked => {
                                root.room-invite-accept-requested(room.room_id);
                            }
                        }

                        if !room.invite_pending: Button {
                            x: 96px;
                            y: 0;
                            width: 88px;
                            text: "Reject";
                            clicked => {
                                root.room-invite-reject-requested(room.room_id);
                            }
                        }
                    }

                    TouchArea {
                        x: 0;
                        y: 0;
                        width: parent.width;
                        height: room.is_invite ? 34px : parent.height;
                        clicked => {
                            root.room-selected(index);
                        }
                    }
                }
            }
        }

        divider := Rectangle {
            x: sidebar.width;
            y: 0;
            width: 8px;
            height: parent.height;
            background: #293347;

            drag := TouchArea {
                width: parent.width;
                height: parent.height;
                mouse-cursor: MouseCursor.col-resize;
                property <float> drag-start-width: 0;

                pointer-event(event) => {
                    if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                        self.drag-start-width = root.sidebar-width-px;
                    }
                }

                moved => {
                    if (self.pressed) {
                        root.sidebar-width-requested(
                            self.drag-start-width + ((self.mouse-x - self.pressed-x) / 1px),
                            app-bg.width / 1px
                        );
                    }
                }
            }
        }

        chat-pane := Rectangle {
            x: divider.x + divider.width;
            y: 0;
            width: parent.width - self.x;
            height: parent.height;
            background: #0f1420;

            status-bar := Rectangle {
                x: 0;
                y: 0;
                width: parent.width;
                height: 38px;
                background: #141b2a;

                Text {
                    x: 14px;
                    y: (parent.height - self.height) / 2;
                    text: root.status-text;
                    color: #b9c3dd;
                    font-size: 13px;
                }
            }

            if root.has-error : Rectangle {
                x: 10px;
                y: status-bar.height + 8px;
                width: parent.width - 20px;
                height: 34px;
                border-radius: 8px;
                background: #65253b;
                border-width: 1px;
                border-color: #b54468;

                Text {
                    x: 10px;
                    y: (parent.height - self.height) / 2;
                    width: parent.width - 20px;
                    text: root.error-text;
                    color: #ffe4ec;
                    overflow: elide;
                }
            }

            property <length> timeline-y: root.has-error ? (status-bar.height + 50px) : (status-bar.height + 8px);

            timeline-list := ListView {
                x: 8px;
                y: chat-pane.timeline-y;
                width: parent.width - 16px;
                height: parent.height - self.y - composer.height - 12px;
                vertical-scrollbar-policy: ScrollBarPolicy.as-needed;
                horizontal-scrollbar-policy: ScrollBarPolicy.as-needed;
                scrolled => {
                    root.timeline-scrolled(self.viewport-y / 1px);
                }

                for message in root.messages: Rectangle {
                    width: parent.width;
                    height: bubble.height + 8px;

                    bubble := Rectangle {
                        width: min(parent.width * 0.68, 520px);
                        x: message.is_own ? (parent.width - self.width - 10px) : 10px;
                        y: 0;
                        border-radius: 12px;
                        border-width: 1px;
                        border-color: message.is_own ? #4e6bb0 : #344157;
                        background: message.is_own ? #2b3d66 : #202a3a;

                        sender := Text {
                            x: 12px;
                            y: 8px;
                            width: parent.width - 24px;
                            text: message.sender;
                            color: #b7c6e6;
                            font-size: 12px;
                            overflow: elide;
                        }

                        if message.event_kind == "image" : VerticalLayout {
                            x: 12px;
                            y: sender.y + sender.height + 6px;
                            width: parent.width - 24px;
                            spacing: 6px;

                            if message.has_media_image : Image {
                                source: message.media_image;
                                width: min(parent.width, 360px);
                                height: 220px;
                                image-fit: contain;

                                TouchArea {
                                    width: parent.width;
                                    height: parent.height;
                                    clicked => {
                                        root.media-screen-image = message.media_image;
                                        root.show-media-screen = true;
                                    }
                                }
                            }

                            if !message.has_media_image : Rectangle {
                                width: parent.width;
                                height: 88px;
                                border-radius: 8px;
                                border-width: 1px;
                                border-color: #4a5772;
                                background: #1b2332;

                                Text {
                                    x: 10px;
                                    y: 12px;
                                    width: parent.width - 20px;
                                    text: "Image: " + message.media_status;
                                    color: #d6e1ff;
                                    overflow: elide;
                                }

                                if message.can_retry : Button {
                                    x: parent.width - self.width - 10px;
                                    y: parent.height - self.height - 10px;
                                    width: 72px;
                                    text: "Retry";
                                    clicked => {
                                        root.media-retry-requested(message.media_source);
                                    }
                                }
                            }

                            if message.caption != "" : Text {
                                text: message.caption;
                                color: #f2f6ff;
                                wrap: word-wrap;
                                horizontal-alignment: left;
                            }

                            if message.can_retry && message.local_id != "" : HorizontalLayout {
                                spacing: 8px;

                                Button {
                                    text: "Retry";
                                    width: 72px;
                                    clicked => {
                                        root.outgoing-media-retry-requested(message.local_id);
                                    }
                                }
                                if message.can_remove : Button {
                                    text: "Remove";
                                    width: 86px;
                                    clicked => {
                                        root.outgoing-media-remove-requested(message.local_id);
                                    }
                                }
                            }
                        }

                        if message.event_kind == "text" : Text {
                            x: 12px;
                            y: sender.y + sender.height + 6px;
                            width: parent.width - 24px;
                            text: message.body;
                            color: #f2f6ff;
                            wrap: word-wrap;
                            horizontal-alignment: left;
                        }

                        height: message.event_kind == "image"
                            ? (sender.y + sender.height + 6px + 220px)
                            : (sender.y + sender.height + 34px);
                    }
                }
            }

            if root.selected-room-id == "" : Text {
                text: "Select a room from the left sidebar to load chat history.";
                color: #8f9cb8;
                font-size: 16px;
                x: (parent.width - self.width) / 2;
                y: (timeline-list.y + timeline-list.height / 2) - 20px;
            }

            composer := Rectangle {
                x: 8px;
                y: parent.height - self.height - 8px;
                width: parent.width - 16px;
                height: 94px;
                border-radius: 10px;
                background: #161f2f;
                border-width: 1px;
                border-color: #2f3c56;

                input := TextEdit {
                    x: 10px;
                    y: 10px;
                    width: parent.width - 220px;
                    height: parent.height - 20px;
                    text <=> root.composer-text;
                    enabled: root.can-send;

                    key-pressed(event) => {
                        if (event.text == Key.Return) {
                            if (!event.modifiers.shift) {
                                if (root.send-message-requested(root.composer-text)) {
                                    root.composer-text = "";
                                }
                                return accept;
                            }
                        }
                        reject
                    }
                }

                send-btn := Button {
                    x: parent.width - self.width - 10px;
                    y: (parent.height - self.height) / 2;
                    width: 110px;
                    text: "Send";
                    enabled: root.can-send;
                    clicked => {
                        if (root.send-message-requested(root.composer-text)) {
                            root.composer-text = "";
                        }
                    }
                }

                attach-btn := Button {
                    x: send-btn.x - self.width - 8px;
                    y: (parent.height - self.height) / 2;
                    width: 92px;
                    text: "Attach";
                    enabled: root.can-send;
                    clicked => {
                        root.attachment-pick-requested();
                    }
                }

                if root.has-composer-attachment : Rectangle {
                    x: 10px;
                    y: parent.height - self.height - 8px;
                    width: parent.width - 20px;
                    height: 24px;
                    border-radius: 6px;
                    background: #24314a;

                    Text {
                        x: 8px;
                        y: 4px;
                        width: parent.width - clear-attachment-btn.width - 20px;
                        text: "Attachment: " + root.composer-attachment-name;
                        color: #d6e1ff;
                        overflow: elide;
                    }

                    clear-attachment-btn := Button {
                        x: parent.width - self.width - 6px;
                        y: 1px;
                        width: 56px;
                        text: "Clear";
                        clicked => {
                            root.attachment-clear-requested();
                        }
                    }
                }
            }
        }
    }

    if root.show-login-screen : Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #0d1320f0;

        Rectangle {
            width: min(parent.width - 40px, 520px);
            height: 420px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #1a2232;
            border-width: 1px;
            border-color: #465675;
            border-radius: 12px;

            Text {
                x: 20px;
                y: 20px;
                text: "Log In";
                color: #f1f4ff;
                font-size: 24px;
                font-weight: 700;
            }

            Text {
                x: 20px;
                y: 58px;
                width: parent.width - 40px;
                text: "Enter your Matrix account details.";
                color: #c4d0ea;
                font-size: 13px;
            }

            Text {
                x: 20px;
                y: 96px;
                text: "Homeserver Host";
                color: #c4d0ea;
                font-size: 12px;
            }
            Text {
                x: 20px;
                y: 124px;
                text: "https://";
                color: #9eb2dc;
                font-size: 14px;
            }
            homeserver-input := TextEdit {
                x: 84px;
                y: 116px;
                width: parent.width - self.x - 20px;
                height: 36px;
                text <=> root.login-homeserver;
                enabled: !root.login-in-flight;
            }

            Text {
                x: 20px;
                y: 162px;
                text: "User ID";
                color: #c4d0ea;
                font-size: 12px;
            }
            user-input := TextEdit {
                x: 20px;
                y: 182px;
                width: parent.width - 40px;
                height: 36px;
                text <=> root.login-user-id;
                enabled: !root.login-in-flight;
            }

            Text {
                x: 20px;
                y: 228px;
                text: "Password";
                color: #c4d0ea;
                font-size: 12px;
            }
            password-input := LineEdit {
                x: 20px;
                y: 248px;
                width: parent.width - 40px;
                height: 36px;
                text <=> root.login-password;
                input-type: InputType.password;
                enabled: !root.login-in-flight;

                key-pressed(event) => {
                    if (event.text == Key.Return && !event.modifiers.shift) {
                        root.login-requested(
                            root.login-homeserver,
                            root.login-user-id,
                            root.login-password,
                            root.login-remember-password
                        );
                        return accept;
                    }
                    reject
                }
            }

            remember-toggle := CheckBox {
                x: 20px;
                y: 300px;
                width: parent.width - 40px;
                text: "Remember password";
                checked <=> root.login-remember-password;
                enabled: !root.login-in-flight;
            }

            login-btn := Button {
                x: parent.width - self.width - 20px;
                y: parent.height - self.height - 20px;
                width: 140px;
                text: root.login-in-flight ? "Logging In..." : "Log In";
                enabled: !root.login-in-flight
                    && root.login-homeserver != ""
                    && root.login-user-id != ""
                    && root.login-password != "";
                clicked => {
                    root.login-requested(
                        root.login-homeserver,
                        root.login-user-id,
                        root.login-password,
                        root.login-remember-password
                    );
                }
            }
        }
    }

    if root.show-logout-confirm : Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        TouchArea {
            width: parent.width;
            height: parent.height;
        }

        Rectangle {
            width: 480px;
            height: 220px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #222a38;
            border-width: 1px;
            border-color: #465675;
            border-radius: 10px;

            Text {
                x: 20px;
                y: 20px;
                width: parent.width - 40px;
                text: "Log Out and Clear Local Data";
                color: #f1f4ff;
                font-size: 20px;
                font-weight: 600;
            }

            Text {
                x: 20px;
                y: 62px;
                width: parent.width - 40px;
                text: "This will clear local chat history, encryption keys, and cache on this device.";
                color: #d6e1ff;
                font-size: 14px;
                wrap: word-wrap;
            }

            cancel-btn := Button {
                text: "Cancel";
                width: 100px;
                x: parent.width - self.width - 136px;
                y: parent.height - self.height - 16px;
                clicked => {
                    root.logout-cancelled();
                }
            }

            confirm-btn := Button {
                text: "Log Out";
                width: 110px;
                x: parent.width - self.width - 16px;
                y: parent.height - self.height - 16px;
                clicked => {
                    root.logout-confirmed();
                }
            }
        }
    }

    if root.show-about-screen : Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        TouchArea {
            width: parent.width;
            height: parent.height;
        }

        Rectangle {
            width: 520px;
            height: 280px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #2e3440;
            border-width: 1px;
            border-color: #4c566a;
            border-radius: 10px;

            AboutSlint {
                x: (parent.width - self.width) / 2;
                y: 24px;
            }

            Button {
                text: "Close";
                width: 100px;
                x: (parent.width - self.width) / 2;
                y: parent.height - self.height - 18px;
                clicked => {
                    root.show-about-screen = false;
                }
            }
        }
    }

    if root.show-security-screen : Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        TouchArea {
            width: parent.width;
            height: parent.height;
        }

        Rectangle {
            width: 640px;
            height: 360px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #222a38;
            border-width: 1px;
            border-color: #465675;
            border-radius: 10px;

            Text {
                x: 16px;
                y: 16px;
                width: parent.width - 32px;
                text: root.security-title;
                color: #f1f4ff;
                font-size: 20px;
                font-weight: 600;
                overflow: elide;
            }

            Text {
                x: 16px;
                y: 58px;
                width: parent.width - 32px;
                height: root.security-show-restore-input ? 82px : (parent.height - 126px);
                text: root.security-body;
                color: #d6e1ff;
                font-size: 14px;
                wrap: word-wrap;
                horizontal-alignment: left;
            }

            restore-input := TextEdit {
                x: 16px;
                y: 150px;
                width: parent.width - 32px;
                height: parent.height - self.y - 64px;
                visible: root.security-show-restore-input;
            }

            restore-btn := Button {
                text: root.security-restore-button-text;
                width: 140px;
                x: 16px;
                y: parent.height - self.height - 16px;
                visible: root.security-show-restore-input;
                enabled: !root.security-restore-in-flight && restore-input.text != "";
                clicked => {
                    root.security-restore-requested(restore-input.text);
                }
            }

            if root.security-show-copy-button : Button {
                text: root.security-copy-button-text;
                width: 120px;
                x: parent.width - self.width - 126px;
                y: parent.height - self.height - 16px;
                clicked => {
                    root.security-copy-requested();
                }
            }

            close-btn := Button {
                text: "Close";
                width: 100px;
                x: parent.width - self.width - 16px;
                y: parent.height - self.height - 16px;
                clicked => {
                    root.security-dialog-dismissed();
                }
            }
        }
    }

    if root.show-media-screen : Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        background: #000000cc;

        TouchArea {
            width: parent.width;
            height: parent.height;
            clicked => {
                root.show-media-screen = false;
            }
        }

        Image {
            x: 24px;
            y: 24px;
            width: parent.width - 48px;
            height: parent.height - 48px;
            source: root.media-screen-image;
            image-fit: contain;
        }
    }
}
